<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>HTTP Task Queue (HTQ) by cbmi</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>HTTP Task Queue (HTQ)</h1>
        <p>Queues HTTP requests and stores the response in Redis for later retrieval</p>
        <p class="view"><a href="https://github.com/cbmi/htq">View the Project on GitHub <small>cbmi/htq</small></a></p>
        <ul>
          <li><a href="https://github.com/cbmi/htq/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/cbmi/htq/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/cbmi/htq">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a name="http-task-queue-htq" class="anchor" href="#http-task-queue-htq"><span class="octicon octicon-link"></span></a>HTTP Task Queue (htq)</h1>

<p>The motivation for this project is to provide a standard interface for sending a request in the background to a service that performs some task with a standard mechanism for signaling it to be <em>cancelled</em>.</p>

<p>In this context, a <em>task</em> is classified as something that may take longer than what is appropriate for a typical HTTP response or something that is allowed to be eventually completed. Examples include executing a database query, running an analysis on some data, and injesting/scraping data from websites or other services. One side effect of the client-server model is that the server may not be aware if the client aborts the request. The server will continue to perform the task using up resources that other tasks or request handlers could be using. The mechanism for signaling a cancellation is for a subsequent DELETE request to be sent to the service which can be handled to interrupt the first request. This of course requires services to support the DELETE method and implement the logic for cancelling the task being performed. See below for a working example of a <a href="#service-example">service</a> implementing this interface.</p>

<p>For a detailed introduction, read the <a href="#tutorial">tutorial</a> below. </p>

<h2>
<a name="dependencies" class="anchor" href="#dependencies"><span class="octicon octicon-link"></span></a>Dependencies</h2>

<ul>
<li>Python 3.3+</li>
<li>Redis 2.4+</li>
</ul><h2>
<a name="command-line-interface" class="anchor" href="#command-line-interface"><span class="octicon octicon-link"></span></a>Command-line Interface</h2>

<pre><code>$ htq -h
HTTP Task Queue (htq) command-line interface

Usage:
    htq server [--host &lt;host&gt;] [--port &lt;port&gt;] [--redis &lt;redis&gt;] [--debug]
    htq worker [--threads &lt;n&gt;] [--redis &lt;redis&gt;] [--debug]

Options:
    -h --help           Show this screen.
    -v --version        Show version.
    --debug             Turns on debug logging.
    --host &lt;host&gt;       Host of the HTTP service [default: localhost].
    --port &lt;port&gt;       Port of the HTTP service [default: 5000].
    --redis &lt;redis&gt;     Host/port of the Redis server [default: localhost:6379].
    --threads &lt;n&gt;       Number of threads a worker should spawn [default: 10].
</code></pre>

<p>Run the server for the HTTP REST interface.</p>

<pre><code>htq server
</code></pre>

<p>Run the worker to send requests and receive responses.</p>

<pre><code>htq worker
</code></pre>

<h2>
<a name="api" class="anchor" href="#api"><span class="octicon octicon-link"></span></a>API</h2>

<ul>
<li>
<code>GET /</code> - Gets all queued requests.</li>
<li>
<code>POST /</code> - Sends (queues) a request</li>
<li>
<code>GET /&lt;uuid&gt;/</code> - Gets a request by UUID</li>
<li>
<code>DELETE /&lt;uuid&gt;/</code> - Cancels a request, deleting it's response if already received</li>
<li>
<code>GET /&lt;uuid&gt;/response/</code> - Gets a request's response if it has been received</li>
<li>
<code>DELETE /&lt;uuid&gt;/response/</code> - Delete a request's response to clear up space</li>
</ul><h2>
<a name="tutorial" class="anchor" href="#tutorial"><span class="octicon octicon-link"></span></a>Tutorial</h2>

<p>Start the HTQ server:</p>

<div class="highlight highlight-bash"><pre><span class="nv">$ </span>htq server
Starting htq REST server...
 * Running on http://localhost:5000/
</pre></div>

<p>Send a POST to the service with a JSON encoded structure of the request to be sent. This immediately returns a <code>303 See Other</code> response with the <code>Location</code> header to the request</p>

<div class="highlight highlight-bash"><pre><span class="nv">$ </span>curl -i -X POST -H <span class="s1">'Content-Type: application/json'</span> http://localhost:5000 -d <span class="s1">'{"url": "http://httpbin.org/ip"}'</span>
HTTP/1.0 <span class="m">303</span> SEE OTHER
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
Content-Length: 0
Location: http://localhost:5000/a936e1a1-68d8-4433-a0c0-4f4b2111670d/
Server: Werkzeug/0.9.6 Python/3.4.1
Date: Mon, <span class="m">29</span> Sep <span class="m">2014</span> 17:18:49 GMT
</pre></div>

<p>See what the request resource looks like (use the URL from the <code>Location</code> header in your output):</p>

<div class="highlight highlight-bash"><pre><span class="nv">$ </span>curl -i http://localhost:5000/a936e1a1-68d8-4433-a0c0-4f4b2111670d/
HTTP/1.0 <span class="m">200</span> OK
Content-Type: application/json
Content-Length: 185
Link: &lt;http://localhost:5000/a936e1a1-68d8-4433-a0c0-4f4b2111670d/response/&gt;<span class="p">;</span> <span class="nv">rel</span><span class="o">=</span><span class="s2">"response"</span>,
      &lt;http://localhost:5000/a936e1a1-68d8-4433-a0c0-4f4b2111670d/&gt;<span class="p">;</span> <span class="nv">rel</span><span class="o">=</span><span class="s2">"self"</span>,
      &lt;http://localhost:5000/a936e1a1-68d8-4433-a0c0-4f4b2111670d/status/&gt;<span class="p">;</span> <span class="nv">rel</span><span class="o">=</span><span class="s2">"status"</span>
Server: Werkzeug/0.9.6 Python/3.4.1
Date: Mon, <span class="m">29</span> Sep <span class="m">2014</span> 17:26:05 GMT

<span class="o">{</span>
    <span class="s2">"timeout"</span>: 60,
    <span class="s2">"status"</span>: <span class="s2">"queued"</span>,
    <span class="s2">"data"</span>: null,
    <span class="s2">"headers"</span>: <span class="o">{}</span>,
    <span class="s2">"url"</span>: <span class="s2">"http://httpbin.org/ip"</span>,
    <span class="s2">"method"</span>: <span class="s2">"get"</span>,
    <span class="s2">"uuid"</span>: <span class="s2">"a936e1a1-68d8-4433-a0c0-4f4b2111670d"</span>,
    <span class="s2">"time"</span>: 1412011537783
<span class="o">}</span>
</pre></div>

<p>The above response shows the details of the request such as the URL, method, headers, and request data. Additionally metadata has been captured when the request was queued including the UUID, the time (in milliseconds) when the request was queued, the status of the request and a timeout. The <code>Link</code> header shows the related links from this resource including one to the response and the status. The status link is a lightweight:</p>

<div class="highlight highlight-bash"><pre><span class="nv">$ </span>curl -i http://localhost:5000/a936e1a1-68d8-4433-a0c0-4f4b2111670d/status/
HTTP/1.0 <span class="m">200</span> OK
Content-Type: application/json
Content-Length: 20
Server: Werkzeug/0.9.6 Python/3.4.1
Date: Mon, <span class="m">29</span> Sep <span class="m">2014</span> 17:30:21 GMT

<span class="o">{</span><span class="s2">"status"</span>: <span class="s2">"queued"</span><span class="o">}</span>
</pre></div>

<p>If we were to <code>curl</code> the response link, it would block until the response is ready. Since we have not started a worker yet, this would be forever. Let's start a worker to actual send the request. Execute this in a separate shell:</p>

<div class="highlight highlight-bash"><pre><span class="nv">$ </span>htq worker --debug
Started <span class="m">10</span> workers...
<span class="o">[</span>a936e1a1-68d8-4433-a0c0-4f4b2111670d<span class="o">]</span> sending request...
<span class="o">[</span>a936e1a1-68d8-4433-a0c0-4f4b2111670d<span class="o">]</span> response received
</pre></div>

<p>Starting the worker daemon immediately starts consuming the queue and sending the requests. As you can see, the one sent above has been sent and the response received. Let's check the status of our request.</p>

<div class="highlight highlight-bash"><pre><span class="nv">$ </span>curl -i http://localhost:5000/a936e1a1-68d8-4433-a0c0-4f4b2111670d/status/
HTTP/1.0 <span class="m">200</span> OK
Content-Type: application/json
Content-Length: 21
Server: Werkzeug/0.9.6 Python/3.4.1
Date: Mon, <span class="m">29</span> Sep <span class="m">2014</span> 17:36:56 GMT

<span class="o">{</span><span class="s2">"status"</span>: <span class="s2">"success"</span><span class="o">}</span>
</pre></div>

<p>Success! Now let's use the link to the response itself.</p>

<div class="highlight highlight-bash"><pre><span class="nv">$ </span>curl -i http://localhost:5000/a936e1a1-68d8-4433-a0c0-4f4b2111670d/response/
HTTP/1.0 <span class="m">200</span> OK
Content-Type: application/json
Content-Length: 19291
Link: &lt;http://localhost:5000/a936e1a1-68d8-4433-a0c0-4f4b2111670d/&gt;<span class="p">;</span> <span class="nv">rel</span><span class="o">=</span><span class="s2">"request"</span>,
      &lt;http://localhost:5000/a936e1a1-68d8-4433-a0c0-4f4b2111670d/response/&gt;<span class="p">;</span> <span class="nv">rel</span><span class="o">=</span><span class="s2">"self"</span>
Server: Werkzeug/0.9.6 Python/3.4.1
Date: Mon, <span class="m">29</span> Sep <span class="m">2014</span> 17:38:22 GMT

<span class="o">{</span>
    <span class="s2">"status"</span>: <span class="s2">"success"</span>,
    <span class="s2">"time"</span>: 1412012019457,
    <span class="s2">"code"</span>: 200,
    <span class="s2">"reason"</span>: <span class="s2">"OK"</span>,
    <span class="s2">"elapsed"</span>: 79.81,
    <span class="s2">"uuid"</span>: <span class="s2">"62db48a4-e511-4c8e-9c11-32b39758d1ff"</span>,
    <span class="s2">"headers"</span>: <span class="o">{</span>
        <span class="s2">"Age"</span>: <span class="s2">"0"</span>,
        <span class="s2">"Content-Length"</span>: <span class="s2">"32"</span>,
        <span class="s2">"Connection"</span>: <span class="s2">"Keep-Alive"</span>,
        <span class="s2">"Access-Control-Allow-Origin"</span>: <span class="s2">"*"</span>,
        <span class="s2">"Server"</span>: <span class="s2">"gunicorn/18.0"</span>,
        <span class="s2">"Access-Control-Allow-Credentials"</span>: <span class="s2">"true"</span>,
        <span class="s2">"Date"</span>: <span class="s2">"Mon, 29 Sep 2014 17:50:29 GMT"</span>,
        <span class="s2">"Content-Type"</span>: <span class="s2">"application/json"</span>
    <span class="o">}</span>,
    <span class="s2">"data"</span>: <span class="s2">"{\n  \"origin\": \"159.14.243.254\"\n}"</span>
<span class="o">}</span>
</pre></div>

<p>The response contains all the elements of an HTTP response including code, reason, headers, and the data (which has been removed for brevity). In addition, the time (in milliseconds) the response was received and the elapsed time (in milliseconds) join the UUID and status metadata.</p>

<h3>
<a name="canceling-a-request" class="anchor" href="#canceling-a-request"><span class="octicon octicon-link"></span></a>Canceling a request</h3>

<p>HTQ defines an interface for services to implement for allowing requests to be canceled. For example, if I send a request that is taking longer than I expect (delayed for 30 seconds):</p>

<div class="highlight highlight-bash"><pre><span class="nv">$ </span>curl -i -X POST -H Content-Type:application/json http://localhost:5000 -d <span class="s1">'{"url": "http://httpbin.org/delay/30"}'</span>
HTTP/1.0 <span class="m">303</span> SEE OTHER
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
Content-Length: 0
Location: http://localhost:5000/1686e1b7-3b05-4d45-95e8-caf934f540aa/
Server: Werkzeug/0.9.6 Python/3.4.1
Date: Mon, <span class="m">29</span> Sep <span class="m">2014</span> 18:00:28 GMT
</pre></div>

<p>Then I can send a DELETE to the request URL:</p>

<div class="highlight highlight-bash"><pre><span class="nv">$ </span>curl -i -X DELETE http://localhost:5000/1686e1b7-3b05-4d45-95e8-caf934f540aa/
HTTP/1.0 <span class="m">204</span> NO CONTENT
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
Content-Length: 0
Server: Werkzeug/0.9.6 Python/3.4.1
Date: Mon, <span class="m">29</span> Sep <span class="m">2014</span> 18:00:41 GMT
</pre></div>

<p>Now if we check the status, we should see the status has changed to <code>canceled</code> (the response is also empty).</p>

<div class="highlight highlight-bash"><pre><span class="nv">$ </span>curl -i http://localhost:5000/9619b267-760d-4f0a-9f15-eb8ad99cd1c4/status/
HTTP/1.0 <span class="m">200</span> OK
Content-Type: application/json
Content-Length: 22
Server: Werkzeug/0.9.6 Python/3.4.1
Date: Mon, <span class="m">29</span> Sep <span class="m">2014</span> 18:01:23 GMT

<span class="o">{</span><span class="s2">"status"</span>: <span class="s2">"canceled"</span><span class="o">}</span>
</pre></div>

<p>Internally this interrupts the request, but also sends a DELETE request to the endpoint (in this <code>http://httpbin.org/delay/30</code>). Implementors of services can support the DELETE request to cancel the underlying processing that is occurring. Of course this is specific to the underlying task being performed, but this simple service-level contract provides a consistent mechanism for signaling the the cancellation.</p>

<h2>
<a name="service-example" class="anchor" href="#service-example"><span class="octicon octicon-link"></span></a>Service Example</h2>

<p>Below is a working example of a service that implements the interface HTQ requires for receiving the DELETE to signal the cancellation. This service takes a JSON-encoded statement and parameters and executes them in a local PostgreSQL instance (for simplicity, the database settings are hard-coded).</p>

<div class="highlight highlight-python"><pre><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">abort</span><span class="p">,</span> <span class="n">request</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="c"># Database connection settings</span>
<span class="n">settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'dbname'</span><span class="p">:</span> <span class="s">'example'</span><span class="p">,</span>
    <span class="s">'host'</span><span class="p">:</span> <span class="s">'localhost'</span><span class="p">,</span>
<span class="p">}</span>

<span class="c"># Currently running tasks by UUID mapped to the</span>
<span class="c"># connection process ID</span>
<span class="n">tasks</span> <span class="o">=</span> <span class="p">{}</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/&lt;uuid&gt;/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">uuid</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">settings</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c"># Store the PID of the connection execute this task</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">get_backend_pid</span><span class="p">()</span>
    <span class="n">tasks</span><span class="p">[</span><span class="n">uuid</span><span class="p">]</span> <span class="o">=</span> <span class="n">pid</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">'[{}] executing query for {}...'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">uuid</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">'statement'</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'parameters'</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()),</span> <span class="mi">200</span>


<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/&lt;uuid&gt;/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'DELETE'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="n">uuid</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">uuid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

    <span class="n">pid</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>

    <span class="c"># Open new connection to cancel the query</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">settings</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'select pg_terminate_backend(</span><span class="si">%s</span><span class="s">)'</span><span class="p">,</span> <span class="p">(</span><span class="n">pid</span><span class="p">,))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">'[{}] canceled query for {}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">uuid</span><span class="p">))</span>

    <span class="k">return</span> <span class="s">''</span><span class="p">,</span> <span class="mi">204</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">threaded</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>

<p>The interaction looks as follows:</p>

<div class="highlight highlight-bash"><pre>% python example_service.py
 * Running on http://127.0.0.1:5000/
<span class="o">[</span>57819<span class="o">]</span> executing query <span class="k">for</span> abc123...
<span class="o">[</span>57819<span class="o">]</span> canceled query <span class="k">for</span> abc123
127.0.0.1 - - <span class="o">[</span>30/Sep/2014 11:16:01<span class="o">]</span> <span class="s2">"DELETE /abc123/ HTTP/1.1"</span> <span class="m">204</span> -
127.0.0.1 - - <span class="o">[</span>30/Sep/2014 11:16:02<span class="o">]</span> <span class="s2">"POST /abc123/ HTTP/1.1"</span> <span class="m">500</span> -
</pre></div>

<p>A POST request was first sent to execute a query. A DELETE request was sent shortly after to cancel the query and returns. When the POST request does respond it is a 500 complaining the connection was closed (which is what we wanted).</p>
      </section>
    </div>
    <footer>
      <p>Project maintained by <a href="https://github.com/cbmi">cbmi</a></p>
      <p>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></p>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>